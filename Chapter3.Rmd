# 3 Logistic regression

*Describe the work you have done this week and summarize your learning.*

- Describe your work and results clearly. 
- Assume the reader has an introductory course level understanding of writing and reading R code as well as statistical methods.
- Assume the reader has no previous knowledge of your data or the more advanced methods you are using.

## 3.1 Introducing the joined dataset

>The dataset describes student achievement in secondary education of two Portuguese schools. The dataset is joined from two datasets regarding the performance in two distinct subjects: Mathematics (mat) and Portuguese language (por). The data attributes include student grades, demographic, social and school related features (and *especially alcohol consumption*) and it was collected by using school reports and questionnaires.
>
>More information: [https://archive.ics.uci.edu/ml/datasets/Student+Performance](https://archive.ics.uci.edu/ml/datasets/Student+Performance)


```{r}
alc <- read.csv("./data/alc.csv") # reading the analysis data
dim(alc) # number of rows and columns
str(alc) # type of data
```
The final **joined dataset** has 382 observations and 35 variables consisting of  only unique individuals. The datasets were joined by using the 13 student identifier variables: "school", "sex", "age", "address", "famsize", "Pstatus", "Medu", "Fedu", "Mjob", "Fjob", "reason", "nursery" and "internet". Only students present in both datasets were kept. The variables not used for joining the two data have been combined by averaging (including the grade variables). A more detailed information about the variables is presented below (possible values in parenthesis):

* 1 school - student's school (binary: 'GP' - Gabriel Pereira or 'MS' - Mousinho da Silveira)
* 2 sex - student's sex (binary: 'F' - female or 'M' - male)
* 3 age - student's age (numeric: from 15 to 22)
* 4 address - student's home address type (binary: 'U' - urban or 'R' - rural)
* 5 famsize - family size (binary: 'LE3' - less or equal to 3 or 'GT3' - greater than 3)
* 6 Pstatus - parent's cohabitation status (binary: 'T' - living together or 'A' - apart)
* 7 Medu - mother's education (numeric: 0 - none, 1 - primary education (4th grade), 2 5th to 9th grade, 3 secondary education or 4 higher education)
* 8 Fedu - father's education (numeric: 0 - none, 1 - primary education (4th grade), 2 5th to 9th grade, 3 secondary education or 4 higher education)
* 9 Mjob - mother's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other')
* 10 Fjob - father's job (nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police), 'at_home' or 'other')
* 11 reason - reason to choose this school (nominal: close to 'home', school 'reputation', 'course' preference or 'other')
* 12 nursery - attended nursery school (binary: yes or no)
* 13 internet - Internet access at home (binary: yes or no)
* 14 guardian - student's guardian (nominal: 'mother', 'father' or 'other')
* 15 traveltime - home to school travel time (numeric: 1 - <15 min., 2 - 15 to 30 min., 3 - 30 min. to 1 hour, or 4 - >1 hour)
* 16 studytime - weekly study time (numeric: 1 - <2 hours, 2 - 2 to 5 hours, 3 - 5 to 10 hours, or 4 - >10 hours)
* 17 failures - number of past class failures (numeric: n if 1<=n<3, else 4)
* 18 schoolsup - extra educational support (binary: yes or no)
* 19 famsup - family educational support (binary: yes or no)
* 20 paid - extra paid classes within the course subject (Math or Portuguese) (binary: yes or no)
* 21 activities - extra-curricular activities (binary: yes or no)
* 22 higher - wants to take higher education (binary: yes or no)
* 23 romantic - with a romantic relationship (binary: yes or no)
* 24 famrel - quality of family relationships (numeric: from 1 - very bad to 5 - excellent)
* 25 freetime - free time after school (numeric: from 1 - very low to 5 - very high)
* 26 goout - going out with friends (numeric: from 1 - very low to 5 - very high)
* 27 Dalc - workday alcohol consumption (numeric: from 1 - very low to 5 - very high)
* 28 Walc - weekend alcohol consumption (numeric: from 1 - very low to 5 - very high)
* 29 health - current health status (numeric: from 1 - very bad to 5 - very good)
* 30 absences - number of school absences (numeric: from 0 to 93)

The grades G1, G2 and G3 are related to the course subject, Math or Portuguese. Variables alc_use and high_use were added to the original datasets:

* 31 G1 - first period grade (numeric: from 0 to 20)
* 32 G2 - second period grade (numeric: from 0 to 20)
* 33 G3 - final grade (numeric: from 0 to 20, output target)
* 34 alc_use - average of Dalc and Walc (numeric: from 1 - very low to 5 - very high)
* 35 high_use - high alcohol use status (binary: TRUE (if alc_use is higher than 2) or FALSE)


## 3.2 Purpose of the analysis and study hypothesis

The purpose of the analysis is to study the relationships between high/low alcohol consumption and some of the other variables in the data. Out of the many variables present,  **parent's cohabitation status**, **mother's education**, **quality of family relationships** and the **number of school absences** were chosen. Thus the study hypothesis are as follows:

<<<<<<< HEAD
* Hypothesis 1: If the parents are living apart (Pstatus), the alcohol consumption (high_use) is higher
* Hypothesis 2: The higher the mother's education (Medu), the lower the alcohol consumption (high_use)
* Hypothesis 3: The higher the quality of family relationships (famrel), the lower the alcohol consumption (high_use)
* Hypothesis 4: The higher the number of school absences (absences), the higher the alcohol consumption (high_use)

Note! Now the target variable high_use is a binary variable (TRUE=1, FALSE=0) so we must use logistic regression.

## 3.3 Numerical and graphical exploration of hypothesis
Let's try modelling the target variable alc_use as a function of our chosen variables.
```{r}
library(dplyr);
alc_hypothesis <- select(alc, Pstatus, Medu, famrel, absences, alc_use, high_use)
library(ggplot2);
library(GGally);
p <- ggpairs(alc_hypothesis, mapping = aes(), lower = list(combo = wrap("facethist", bins = 20)))
p # graphical summary
summary(alc_hypothesis) # numerical summary
```

fef
```{r}
library(dplyr)
m <- glm(high_use ~ famrel, data = alc, family ="binomial")

# print out a summary of the model
summary(m)

# print out the coefficients of the model
coef(m)


# compute odds ratios (OR)
OR <- coef(m) %>% exp

# compute confidence intervals (CI)
CI <- confint(m) %>% exp

# print out the odds ratios with their confidence intervals
cbind(OR, CI)

# fit the model
m <- glm(high_use ~ failures + absences + sex, data = alc, family = "binomial")

# predict() the probability of high_use
probabilities <- predict(m, type = "response")

# add the predicted probabilities to 'alc'
alc <- mutate(alc, probability = probabilities)

# use the probabilities to make a prediction of high_use
alc <- mutate(alc, prediction = probabilities>0.5)

# see the last ten original classes, predicted probabilities, and class predictions
select(alc, failures, absences, sex, high_use, probability, prediction) %>% tail(10)

# tabulate the target variable versus the predictions
select(alc, high_use, prediction) %>% table()

# alc is available

# access dplyr and ggplot2
library(dplyr); library(ggplot2)

# initialize a plot of 'high_use' versus 'probability' in 'alc'
g <- ggplot(alc, aes(x =probability, y = high_use, col=prediction))

# define the geom as points and draw the plot
g+geom_point()

# tabulate the target variable versus the predictions
table(high_use = alc$high_use, prediction = alc$prediction) %>% prop.table() %>% addmargins()

# the logistic regression model m and dataset alc with predictions are available

# define a loss function (mean prediction error)
loss_func <- function(class, prob) {
  n_wrong <- abs(class - prob) > 0.5
  mean(n_wrong)
}

# call loss_func to compute the average number of wrong predictions in the (training) data
loss_func(class = alc$high_use, prob = alc$probability)
# the logistic regression model m and dataset alc (with predictions) are available

# define a loss function (average prediction error)
loss_func <- function(class, prob) {
  n_wrong <- abs(class - prob) > 0.5
  mean(n_wrong)
}

# compute the average number of wrong predictions in the (training) data
loss_func(alc$high_use,prob=alc$probability)

# K-fold cross-validation
library(boot)
cv <- cv.glm(data = alc, cost = loss_func, glmfit = m, K = 10)

# average number of wrong predictions in the cross validation
cv$delta[1]

=======
* Hypothesis 1: If the parents are living apart (Pstatus), the alcohol consumption (alc_use) is higher
* Hypothesis 2: The higher the mother's education (Medu), the lower the alcohol consumption (alc_use)
* Hypothesis 3: The higher the quality of family relationships (famrel), the lower the alcohol consumption (alc_use)
* Hypothesis 4: The higher the number of school absences (absences), the higher the alcohol consumption (alc_use)


## 3.3 Numerical and graphical exploration of hypothesis

```{r}
#summary(alc) # numerical summary
>>>>>>> 9f0da12477f44b5e09947a52f6d262392212e3a1
```